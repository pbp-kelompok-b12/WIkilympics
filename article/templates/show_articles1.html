{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Berita Olahraga</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %} 

<div class="min-h-screen bg-blue-950 text-white p-8 pt-20">
    <div class="max-w-7xl mx-auto">

        <!-- Judul utama -->
        <h1 class="text-3xl font-bold mb-8 border-b border-blue-700 pb-3 pt-5">Sports Article</h1>
        
        <!-- Deskripsi -->
        <p class="text-lg text-gray-300 mb-10">
        Stay updated with the latest sports news and stories — from record-breaking performances 
        to behind-the-scenes moments. Explore insights, highlights, and inspiring journeys from the world of sports.
        </p>

        <!-- Filter categories -->
        <div class="mt-8 mb-6">
            <label for="category-filter-select" class="block text-xl font-semibold mb-2 text-white">Filter by Category</label>
            <select id="category-filter-select" onchange="filterArticles(this.value)"
                class="block w-full sm:w-1/3 md:w-1/4 lg:w-1/5 border border-blue-700 rounded-md px-3 py-2 bg-blue-900 text-white focus:ring-yellow-400 focus:border-yellow-400">
                </select>
        </div>

        <!-- Seksi Sorotan -->
        <div class="bg-blue-900/40 rounded-2xl p-6 shadow-lg border border-blue-800">
        <h2 class="text-2xl font-semibold text-white mb-2">Article Highlights</h2>
        <p class="text-gray-300">
            Catch up on the top trending matches, athlete spotlights, and exclusive analysis from experts. 
            Discover stories that move the game forward.
        </p>

        <div id="trending-list" class="flex overflow-x-auto space-x-6 pb-4 scrollbar-hide"></div>
        
        </div>

        <!-- Tombol Tambah Artikel -->
        {% if request.user.is_superuser %}
        <div class="mt-6">
            <button onclick="showAddModal()" class="bg-yellow-400 text-blue-950 font-semibold px-6 py-2 rounded-full hover:bg-yellow-300 transition-all duration-300">
                Add New Article
            </button>
        </div>
        {% endif %}

        <h2 class="text-2xl font-semibold mt-10 mb-4 border-b border-blue-800 pb-2">Latest Articles</h2>
        <div id="articles-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div> 
    </div>
</div>

<div id="crudModal" class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-gray-900 bg-opacity-70">
    <div id="crudModalContent" class="bg-blue-950 text-white rounded-lg shadow-2xl w-5/6 sm:w-3/5 md:w-1/2 lg:w-2/5 xl:w-1/3 max-h-[90vh] overflow-y-auto transform transition-all duration-300 opacity-0 scale-95 border border-blue-700">
        
        <div class="flex items-center justify-between p-4 border-b border-blue-700">
            <div>
                <h3 id="modalTitle" class="text-xl font-bold text-yellow-400">
                    Publish New Article
                </h3>
                <p class="text-sm text-blue-300 mt-1">Share a new sports story to the Wikilympics catalog.</p>
            </div>
            <button type="button" class="text-blue-300 bg-transparent hover:bg-blue-800 hover:text-white rounded-lg text-sm p-1.5 ml-auto inline-flex items-center" onclick="hideModal()">
                <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
                <span class="sr-only">Close modal</span>
            </button>
        </div>

        <div class="px-6 py-4 space-y-4">
            <form id="articleForm">
                {% csrf_token %} 
                <input type="hidden" id="articleId" name="id" value="">
                <div class="mb-4">
                    <label for="title" class="block text-sm font-medium text-blue-300">Article Title</label>
                    <input type="text" id="title" name="title" class="mt-1 block w-full border border-blue-700 rounded-md px-3 py-2 bg-blue-900 text-white placeholder-blue-500 focus:ring-yellow-400 focus:border-yellow-400" placeholder="Enter article title" required>
                </div>
                
                <div class="mb-4">
                    <label for="category" class="block text-sm font-medium text-blue-300">Category</label>
                    <select id="category" name="category" class="mt-1 block w-full border border-blue-700 rounded-md px-3 py-2 bg-blue-900 text-white focus:ring-yellow-400 focus:border-yellow-400" required>
                        <option value="" disabled selected class="text-gray-500">Choose a category...</option>
                        <option value="athletics">Athletics</option>
                        <option value="swimming">Swimming</option>
                        <option value="b">B (Category B)</option>
                        <option value="a">A (Category A)</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label for="content" class="block text-sm font-medium text-blue-300">Article Content</label>
                    <textarea id="content" name="content" rows="6" class="mt-1 block w-full border border-blue-700 rounded-md px-3 py-2 bg-blue-900 text-white placeholder-blue-500 focus:ring-yellow-400 focus:border-yellow-400" placeholder="Write your full article content here..." required></textarea>
                </div>

                <div class="mb-4">
                    <label for="thumbnail" class="block text-sm font-medium text-blue-300">Thumbnail URL</label>
                    <input type="url" id="thumbnail" name="thumbnail" class="mt-1 block w-full border border-blue-700 rounded-md px-3 py-2 bg-blue-900 text-white placeholder-blue-500 focus:ring-yellow-400 focus:border-yellow-400" placeholder="https://example.com/image.jpg" required>
                </div>
                
            </form>
        </div>

        <div class="flex flex-col sm:flex-row gap-4 p-6 border-t border-blue-700 rounded-b">
            <button type="button" class="order-2 sm:order-1 px-6 py-3 border border-blue-700 text-blue-300 rounded-md font-medium hover:bg-blue-800 transition-colors text-center" onclick="hideModal()">Cancel</button>
            <button type="submit" id="submitArticle" form="articleForm" class="order-1 sm:order-2 flex-1 bg-yellow-400 text-blue-950 px-6 py-3 rounded-md font-bold hover:bg-yellow-300 transition-colors">Publish Article</button>
        </div>
    </div>
</div>

<script>
const IS_AUTHENTICATED = "{{ request.user.is_authenticated|yesno:'true,false' }}" === 'true';
const IS_ADMIN = "{{ request.user.is_superuser|yesno:'true,false' }}";

const URL_JSON = "{% url 'article:show_json' %}";
const URL_ADD = "{% url 'article:add_article' %}";
const URL_EDIT = `{% url 'article:delete_article' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', id);
const URL_DELETE = id => `{% url 'article:delete_article' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', id);

const URL_LIKE = id => `{% url 'article:like_article' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', id);
const URL_DISLIKE = id => `{% url 'article:dislike_article' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', id);
const URL_DETAIL = id => `{% url 'article:article_detail' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', id);

const GRID = document.getElementById("articles-grid");
const TRENDING = document.getElementById("trending-list");

const CATEGORY_SELECT = document.getElementById("category-filter-select");
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

let ALL_ARTICLES=[];
let CURRENT_FILTER='all'

function showModal() {
    const modal = document.getElementById('crudModal');
    const modalContent = document.getElementById('crudModalContent');

    if (modal) {
        modal.classList.remove('hidden'); 
        setTimeout(() => {
            modalContent.classList.remove('opacity-0', 'scale-95');
            modalContent.classList.add('opacity-100', 'scale-100');
        }, 50); 
    }
}

function hideModal() {
    const modal = document.getElementById('crudModal');
    const modalContent = document.getElementById('crudModalContent');

    if (modal) {
        modalContent.classList.remove('opacity-100', 'scale-100');
        modalContent.classList.add('opacity-0', 'scale-95');

        setTimeout(() => {
            modal.classList.add('hidden');
        }, 150); 
    }
}

// Modal add
function showAddModal() {
    document.getElementById('articleForm').reset();
    document.getElementById('articleId').value = '';
    document.getElementById('modalTitle').textContent = 'Publish New Article';
    document.getElementById('submitArticle').textContent = 'Publish Article';
    showModal();
}

// Modal edit
async function showEditModal(id) {
    const detailUrl = `{% url 'article:show_json_id' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', id);
    
    const res = await fetch(detailUrl);
    const article = await res.json();

    document.getElementById('articleId').value = article.id;

    document.getElementById('title').value = article.title;
    document.getElementById('category').value = article.category;
    document.getElementById('content').value = article.content;
    document.getElementById('thumbnail').value = article.thumbnail;

    document.getElementById('modalTitle').textContent = 'Edit Article';
    document.getElementById('submitArticle').textContent = 'Save Changes';

    showModal(); 
}

function createCategoryOptions(articles) {
    const categories = new Set();
    articles.forEach(a => categories.add(a.category.toLowerCase()));

    // Tambahkan opsi 'All'
    let optionsHtml = `<option value="all">-- All Categories --</option>`;

    // Tambahkan opsi untuk setiap kategori unik
    categories.forEach(cat => {
        const displayCat = cat.charAt(0).toUpperCase() + cat.slice(1);
        optionsHtml += `<option value="${cat}">${displayCat}</option>`;
    });

    CATEGORY_SELECT.innerHTML = optionsHtml;
    // Set nilai default (penting saat memuat ulang data)
    CATEGORY_SELECT.value = CURRENT_FILTER;
}

function filterArticles(category) {
    CURRENT_FILTER = category;
    
    let articlesToRender = ALL_ARTICLES;

    if (category !== 'all') {
        articlesToRender = ALL_ARTICLES.filter(a => a.category.toLowerCase() === category);
    }
    
    // Pisahkan data yang sudah difilter ke trending dan normal
    const trending = articlesToRender.filter(a => a.likes > 6);
    const normal = articlesToRender.filter(a => a.likes <= 6);

    TRENDING.innerHTML = trending.length
        ? trending.map(a => renderArticle(a, true)).join('')
        : "<p class='text-blue-400'>No trending articles in this category.</p>";

    GRID.innerHTML = normal.length
        ? normal.map(a => renderArticle(a)).join('')
        : "<p class='text-blue-400 text-center'>No articles found in this category.</p>";
}

// Format waktu
function formatTimeAgo(date) {
  const diff = (new Date() - new Date(date)) / 1000;
  if (diff < 60) return `${Math.round(diff)}s ago`;
  if (diff < 3600) return `${Math.round(diff / 60)}m ago`;
  if (diff < 86400) return `${Math.round(diff / 3600)}h ago`;
  return `${Math.round(diff / 86400)}d ago`;
}

// Fungsi untuk menampilkan peringatan login
function showLoginAlert(e) {
    if (e) {
        // Mencegah navigasi bawaan browser (href="#")
        e.preventDefault(); 
        e.stopPropagation();
    }
    alert('Anda harus login terlebih dahulu untuk melihat detail artikel.');
    return false;
}

// Render and fetch
async function loadArticles() {
    GRID.innerHTML = "<p class='text-blue-400 text-center'>Loading...</p>";
    TRENDING.innerHTML = "";
    CATEGORY_SELECT.innerHTML="";

    const res = await fetch(URL_JSON);
    const data = await res.json();

    ALL_ARTICLES = data; 

    if (!ALL_ARTICLES.length) {
        GRID.innerHTML = "<p class='text-blue-400 text-center'>No articles found.</p>";
        return;
    }

    createCategoryOptions(ALL_ARTICLES);
    filterArticles(CURRENT_FILTER);
}

// Article card
function renderArticle(a, horizontal = false) {
    const likeColor = a.is_liked ? 'text-yellow-400' : 'hover:text-yellow-400';
    const dislikeColor = a.is_disliked ? 'text-red-400' : 'hover:text-red-400';
    
    // Kelas dasar yang WAJIB ADA di semua tombol untuk visual yang konsisten
    const baseButtonClasses = 'flex items-center gap-1 px-3 py-1 rounded-full text-sm transition-all duration-200';
    
    // Kelas default (Pasif): Teks abu-abu terang, latar transparan dengan border tipis
    const passiveClasses = 'text-gray-400 border border-blue-700 hover:bg-blue-800';
    
    // Kelas aktif Like: Latar kuning, teks biru gelap (kontras tinggi)
    const activeLikeClasses = 'bg-yellow-400 text-blue-950 font-bold border-yellow-400 shadow-md';
    
    // Kelas aktif Dislike: Latar merah, teks putih
    const activeDislikeClasses = 'bg-red-600 text-white font-bold border-red-600 shadow-md';

    // Tentukan kelas akhir untuk Like
    const likeClasses = a.is_liked 
        ? `${baseButtonClasses} ${activeLikeClasses}` 
        : `${baseButtonClasses} ${passiveClasses}`;

    // Tentukan kelas akhir untuk Dislike
    const dislikeClasses = a.is_disliked 
        ? `${baseButtonClasses} ${activeDislikeClasses}` 
        : `${baseButtonClasses} ${passiveClasses}`;




    
    
    const img = a.thumbnail || 'https://via.placeholder.com/400x200?text=No+Image';
    const card = horizontal ? "w-80 flex-shrink-0" : "w-full";

    let detailLink;
    if (IS_AUTHENTICATED) {
        detailLink = `href="${URL_DETAIL(a.id)}"`
    } else {
        detailLink = `href="#" onclick="showLoginAlert(event); return false;"`;
    }

    // Delete button for admin
    const adminActions = IS_ADMIN ? `
        <button onclick="showEditModal('${a.id}')" class="text-yellow-400 hover:text-yellow-300 font-bold text-sm">
            Edit
        </button>
        <button onclick="deleteArticle('${a.id}')" class="text-red-500 hover:text-red-400 font-bold text-sm">
            Delete
        </button>
    ` : '';

    return `
    <div class="bg-blue-900 border border-blue-700 rounded-lg overflow-hidden shadow ${card}">
        <a ${detailLink}><img src="${img}" class="w-full h-48 object-cover"></a>
        <div class="p-4">
            <p class="text-sm text-blue-300">${a.category}</p>
            <h2 class="text-lg font-semibold text-white mb-2">${a.title}</h2>
            <p class="text-blue-400 text-sm mb-3">${a.content.slice(0, 100)}...</p>
            <div class="flex justify-between items-center text-sm">
                <span class="text-blue-500">${formatTimeAgo(a.created)}</span>
                <div class="flex gap-3">
                    <button onclick="react('${a.id}','like')" class="${likeClasses}">👍 ${a.likes}</button>
                    <button onclick="react('${a.id}','dislike')" class="${dislikeClasses}">👎</button>
                    ${adminActions}
                </div>
            </div>
        </div>
    </div>`;
}

// Delete article
async function deleteArticle(id) {
    if (!IS_ADMIN) return;

    // Konfirmasi
    const confirmed = window.confirm("Are you sure you want to delete this article?");
    if (!confirmed) return;

    const res = await fetch(URL_DELETE(id), {
    method: 'POST',
    headers: { 'X-CSRFToken': csrfToken },
    });
    const data = await res.json();
    if (data.success) loadArticles();
}

// Like/dislike handler
async function react(id, action) {
    const url = action === 'like' ? URL_LIKE(id) : URL_DISLIKE(id);

    const res = await fetch(url, {
    method: "POST",
    headers: { "X-CSRFToken": csrfToken }
    });

    if (res.status === 403) {
        alert('Login untuk memberi reaksi');
        return;
    }

    const data = await res.json();
    if (data.success) loadArticles();
}

// Tambah/edit article
document.getElementById("articleForm").addEventListener("submit", async e => {
    e.preventDefault();
    const form = e.target;
    const articleId = document.getElementById('articleId').value;
    
    let url, method;

    // Edit
    if (articleId) {
        url = URL_EDIT
    } else {    // Add
        url = URL_ADD;
    }

    const res = await fetch(url, {
        method: "POST",
        headers: { "X-CSRFToken": csrfToken },
        body: new FormData(form)
    });
    
    const data = await res.json();
    
    if (data.success) {
        form.reset();
        hideModal(); 
        loadArticles();
    }
});

document.addEventListener("DOMContentLoaded", loadArticles);

</script>

{% endblock content %}